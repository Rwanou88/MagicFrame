####### MagicFrame #######

# Forcast & Events / Prévisions météo et événements
- trigger:
    - trigger: time_pattern
      minutes: /1
    - trigger: homeassistant
      event: start

  action:
    # Forcast / Prévisions météo
    - action: weather.get_forecasts
      data:
        type: daily
      target:
        entity_id: weather.forecast_YourCity # Entity ID of your weather forecast app. / ID d'entité de votre application de prévisions météo
      response_variable: daily

    # Events / Événements
    - action: calendar.get_events
      data:
        duration:
          hours: 2160 # 90 days / 90 jours
      target:
        entity_id: calendar.YourCalendarName # Your calendar entity ID / Votre identifiant d'entité de calendrier
      response_variable: monthly

  sensor:   
    # Forcast / Prévisions météo
    - name: Weather Forecast Daily
      unique_id: weather_forecast_daily
      state: "{{ now().isoformat() }}"
      attributes:
        forecast: "{{ daily['weather.forecast_YourCity'].forecast }}" # Entity ID of your weather forecast app. / ID d'entité de votre application de prévisions météo

    # Weather day 1 / Météo jour 1
    - name: "weather day 1"
      state: >
        {% set ts = as_timestamp(state_attr('sensor.weather_forecast_daily', 'forecast')[0].datetime) %}
        {% set d = ts | timestamp_custom('%a') %}
        {% set days = {"Mon":"Lun","Tue":"Mar","Wed":"Mer","Thu":"Jeu","Fri":"Ven","Sat":"Sam","Sun":"Dim"} %}
        {{ days[d] }}
    - name: "weather condition 1"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[0].condition }}"
    - name: "weather temperature 1"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[0].temperature }}"
      unit_of_measurement: °C
    - name: "weather templow 1"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[0].templow }}"
      unit_of_measurement: °C

    # Weather day 2 / Météo jour 2
    - name: "weather day 2"
      state: >
        {% set ts = as_timestamp(state_attr('sensor.weather_forecast_daily', 'forecast')[1].datetime) %}
        {% set d = ts | timestamp_custom('%a') %}
        {% set days = {"Mon":"Lun","Tue":"Mar","Wed":"Mer","Thu":"Jeu","Fri":"Ven","Sat":"Sam","Sun":"Dim"} %}
        {{ days[d] }}
    - name: "weather condition 2"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[1].condition }}"
    - name: "weather temperature 2"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[1].temperature }}"
      unit_of_measurement: °C
    - name: "weather templow 2"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[1].templow }}"
      unit_of_measurement: °C

    # Weather day 3 / Météo jour 3
    - name: "weather day 3"
      state: >
        {% set ts = as_timestamp(state_attr('sensor.weather_forecast_daily', 'forecast')[2].datetime) %}
        {% set d = ts | timestamp_custom('%a') %}
        {% set days = {"Mon":"Lun","Tue":"Mar","Wed":"Mer","Thu":"Jeu","Fri":"Ven","Sat":"Sam","Sun":"Dim"} %}
        {{ days[d] }}
    - name: "weather condition 3"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[2].condition }}"
    - name: "weather temperature 3"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[2].temperature }}"
      unit_of_measurement: °C
    - name: "weather templow 3"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[2].templow }}"
      unit_of_measurement: °C

    # Weather day 4 / Météo jour 4
    - name: "weather day 4"
      state: >
        {% set ts = as_timestamp(state_attr('sensor.weather_forecast_daily', 'forecast')[3].datetime) %}
        {% set d = ts | timestamp_custom('%a') %}
        {% set days = {"Mon":"Lun","Tue":"Mar","Wed":"Mer","Thu":"Jeu","Fri":"Ven","Sat":"Sam","Sun":"Dim"} %}
        {{ days[d] }}
    - name: "weather condition 4"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[3].condition }}"
    - name: "weather temperature 4"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[3].temperature }}"
      unit_of_measurement: °C
    - name: "weather templow 4"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[3].templow }}"
      unit_of_measurement: °C

    # Weather day 5 / Météo jour 5
    - name: "weather day 5"
      state: >
        {% set ts = as_timestamp(state_attr('sensor.weather_forecast_daily', 'forecast')[4].datetime) %}
        {% set d = ts | timestamp_custom('%a') %}
        {% set days = {"Mon":"Lun","Tue":"Mar","Wed":"Mer","Thu":"Jeu","Fri":"Ven","Sat":"Sam","Sun":"Dim"} %}
        {{ days[d] }}
    - name: "weather condition 5"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[4].condition }}"
    - name: "weather temperature 5"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[4].temperature }}"
      unit_of_measurement: °C
    - name: "weather templow 5"
      state: "{{ state_attr('sensor.weather_forecast_daily', 'forecast')[4].templow }}"
      unit_of_measurement: °C

    # Raw event storage / Stockage brute des événements
    - name: monthly_events
      unique_id: monthly_events
      state: "{{ now().isoformat() }}"
      attributes:
        events: "{{ monthly['calendar.YourCalendarName'].events }}" # Your calendar entity ID / Votre identifiant d'entité de calendrier

    # Today's date in English / Date du jour en français
    - name: date_fr
      state: >
        {% set ts = as_timestamp(states('sensor.date_time_iso')) %}
        {% set d = ts | timestamp_custom('%A') %}
        {% set m = ts | timestamp_custom('%B') %}
        {% set days = {"Monday":"Lundi","Tuesday":"Mardi","Wednesday":"Mercredi","Thursday":"Jeudi","Friday":"Vendredi","Saturday":"Samedi","Sunday":"Dimanche"} %}
        {% set months = {"January":"Janvier","February":"Février","March":"Mars","April":"Avril","May":"Mai","June":"Juin","July":"Juillet","August":"Août","September":"Septembre","October":"Octobre","November":"Novembre","December":"Décembre"} %}
        {{ days[d] }} {{ ts | timestamp_custom('%-d') }} {{ months[m] }}

    # Event Sorting / Tri des événements
    - name: monthly_events_sorted
      state: "{{ now().isoformat() }}"
      attributes:
        events: >
          {% set events = state_attr('sensor.monthly_events', 'events') %}
          {% set sorted = events | sort(attribute='start') %}
          {{ sorted | to_json }}

    # Automatic generation of the next 5 events / Génération automatique des 5 prochains événements
    # Event 1 / Événement 1
    - name: event_start_1
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {% set ts = as_timestamp(events[0].start) %}
          {% set d = ts | timestamp_custom('%A') %}
          {% set m = ts | timestamp_custom('%B') %}
          {% set days = {"Monday":"Lundi","Tuesday":"Mardi","Mercredi":"Mercredi","Thursday":"Jeudi","Friday":"Vendredi","Saturday":"Samedi","Sunday":"Dimanche"} %}
          {% set months = {"January":"Janvier","February":"Février","March":"Mars","April":"Avril","May":"Mai","June":"Juin","July":"Juillet","August":"Août","September":"Septembre","October":"Octobre","November":"Novembre","December":"Décembre"} %}
          {{ days[d] }} {{ ts | timestamp_custom('%-d') }} {{ months[m] }}
        {% endif %}
    - name: event_summary_1
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {{ events[0].summary }}
        {% endif %}

    # Event 2 / Événement 2
    - name: event_start_2
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {% set ts = as_timestamp(events[1].start) %}
          {% set d = ts | timestamp_custom('%A') %}
          {% set m = ts | timestamp_custom('%B') %}
          {% set days = {"Monday":"Lundi","Tuesday":"Mardi","Mercredi":"Mercredi","Thursday":"Jeudi","Friday":"Vendredi","Saturday":"Samedi","Sunday":"Dimanche"} %}
          {% set months = {"January":"Janvier","February":"Février","March":"Mars","April":"Avril","May":"Mai","June":"Juin","July":"Juillet","August":"Août","September":"Septembre","October":"Octobre","November":"Novembre","December":"Décembre"} %}
          {{ days[d] }} {{ ts | timestamp_custom('%-d') }} {{ months[m] }}
        {% endif %}
    - name: event_summary_2
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {{ events[1].summary }}
        {% endif %}

    # Event 3 / Événement 3
    - name: event_start_3
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {% set ts = as_timestamp(events[2].start) %}
          {% set d = ts | timestamp_custom('%A') %}
          {% set m = ts | timestamp_custom('%B') %}
          {% set days = {"Monday":"Lundi","Tuesday":"Mardi","Mercredi":"Mercredi","Thursday":"Jeudi","Friday":"Vendredi","Saturday":"Samedi","Sunday":"Dimanche"} %}
          {% set months = {"January":"Janvier","February":"Février","March":"Mars","April":"Avril","May":"Mai","June":"Juin","July":"Juillet","August":"Août","September":"Septembre","October":"Octobre","November":"Novembre","December":"Décembre"} %}
          {{ days[d] }} {{ ts | timestamp_custom('%-d') }} {{ months[m] }}
        {% endif %}
    - name: event_summary_3
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {{ events[2].summary }}
        {% endif %}

    # Event 4 / Événement 4
    - name: event_start_4
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {% set ts = as_timestamp(events[3].start) %}
          {% set d = ts | timestamp_custom('%A') %}
          {% set m = ts | timestamp_custom('%B') %}
          {% set days = {"Monday":"Lundi","Tuesday":"Mardi","Mercredi":"Mercredi","Thursday":"Jeudi","Friday":"Vendredi","Saturday":"Samedi","Sunday":"Dimanche"} %}
          {% set months = {"January":"Janvier","February":"Février","March":"Mars","April":"Avril","May":"Mai","June":"Juin","July":"Juillet","August":"Août","September":"Septembre","October":"Octobre","November":"Novembre","December":"Décembre"} %}
          {{ days[d] }} {{ ts | timestamp_custom('%-d') }} {{ months[m] }}
        {% endif %}
    - name: event_summary_4
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {{ events[3].summary }}
        {% endif %}

    # Event 5 / Événement 5
    - name: event_start_5
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {% set ts = as_timestamp(events[4].start) %}
          {% set d = ts | timestamp_custom('%A') %}
          {% set m = ts | timestamp_custom('%B') %}
          {% set days = {"Monday":"Lundi","Tuesday":"Mardi","Mercredi":"Mercredi","Thursday":"Jeudi","Friday":"Vendredi","Saturday":"Samedi","Sunday":"Dimanche"} %}
          {% set months = {"January":"Janvier","February":"Février","March":"Mars","April":"Avril","May":"Mai","June":"Juin","July":"Juillet","August":"Août","September":"Septembre","October":"Octobre","November":"Novembre","December":"Décembre"} %}
          {{ days[d] }} {{ ts | timestamp_custom('%-d') }} {{ months[m] }}
        {% endif %}
    - name: event_summary_5
      state: >
        {% set events = state_attr('sensor.monthly_events_sorted', 'events') %}
        {% if events|length > 0 %}
          {{ events[4].summary }}
        {% endif %}
